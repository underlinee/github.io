<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>이펙티브 파이썬 - 병행성과 병렬성</title>
  <meta name="description" content="자식 프로세스를 관리하려면 subprocess를 사용하자파이썬은 커맨드라인 도구와 가은 여러 도구를 연계하는데 좋은 언어다. 파이썬에서 외부 서브 프로세스 실행을 위해 subprocess 모듈을 사용하자. 자식 프로세스는 파이썬 인터프리터에서 병렬로 실행되어 CPU 사용을 극대화 ...">
  
  <meta name="author" content="JB">
  <meta name="copyright" content="&copy; JB 2018">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  

  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://underlinee.github.io/devbook/2018/03/05/9791186978825.html">
  <link rel="alternate" type="application/rss+xml" title="Underlinee" href="http://underlinee.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <!-- <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="Underlinee">
      
    </a> -->
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
        
          
          <li class="nav-link"><a href="/bookshelf/">Bookshelf</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">이펙티브 파이썬 - 병행성과 병렬성</h1>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">March 5, 2018</div>
  <div class="post-categories">
  in 
    
    <a href="/category/DevBook">Devbook</a>
    
  
  </div>
</section>

<article class="post-content">
  <h2 id="subprocess-">자식 프로세스를 관리하려면 subprocess를 사용하자</h2>
<p>파이썬은 커맨드라인 도구와 가은 여러 도구를 연계하는데 좋은 언어다. 파이썬에서 외부 서브 프로세스 실행을 위해 subprocess 모듈을 사용하자. 자식 프로세스는 파이썬 인터프리터에서 병렬로 실행되어 CPU 사용을 극대화 시킨다. 이때 communicate에 time out을 지정해서 deadlock을 방지하도록 하자.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>proc = subprocess.Popen(
    ['echo', 'Hello from the child!'], stdout=subprocess.PIPE)
out, err = proc.communicate()
print(out.decode('utf-8'))
</code></pre>
</div>

<p><br /></p>

<h2 id="io----">스레드를 블로킹 I/O용으로 사용하고 병렬화용으로는 사용하지 말자</h2>
<p>파이썬 스레드는 GIL 때문에 멀티코어 CPU에서 병렬로 바이트코드를 실행할 수 없다. GIL에도 불구하고 파이썬 스레드는 동시에 여러 작업을 하도록, 즉 병행성을 실현가능하게 해주며 병행성은 특정 종류의 블로킹 I/O를 다뤄야하는 여러 시스템 호출을 사용할 시 유용하다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>threads = []
for _ in range(5):
    thread = Thread(target=slow_systemcall)
    thread.start()
    threads.append(thread)

for thread in threads:
    thread.join()
</code></pre>
</div>

<p><br /></p>

<h2 id="lock-">스레드에서 데이터 경쟁을 막으려면 Lock을 사용하자</h2>
<p>GIL로 한 스레드만 실행되지만, 자료구조를 다루는 연산은 바이트 코드 명령어 사이에서 인터럽트 될 수 있다. 때문에 여러 스레드가 같은 객체를 수정하기 위해서는 내장 모듈 threading의 Lock 클래스를 사용하자. Lock 클래스는 상호 배제 잠금 기능을 제공하는 뮤텍스다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
class LockingCounter(object):
    def __init__(self):
        self.lock = Lock()
        self.count = 0

    def increment(self, offset):
        with self.lock:
            self.count += offset

counter = LockingCounter()

for _i in range(5):
    args = (i, how_many, counter)
    thread = Thread(target=count_func, args)
    thread.start()
    threads.append(thread)
for thread in threads:
    thread.join()
</code></pre>
</div>

<p><br /></p>

<h2 id="queue-">스레드 간의 작업을 조율하려면 Queue를 사용하자</h2>
<p>파이프라인은 여러 파이썬 스레드를 사용하여 동시에 실행하는 작업의 순서를 구성하기 좋은 방법이다. 하지만 작업 완료의 확인, busy waiting, 메모리 이슈 등 고려해야 할 요소가 많기 때문에 직접 파이프라인을 구축하는것은 생각보다 쉽지 않다. 이런 경우 내장 모듈의 Queue 클래스를 사용하자. 버펴 크기를 지정하고, task_done() 작업 완료를 알려서 join() 완료까지 대기할 수 있는 등 필요한 기능을 모두 제공한다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>queue = Queue(10)

def consumer():
     work = queue.get()
     queue.task_done()

Thread(target=consumer()).start()

queue.put(item)
queue.join()
</code></pre>
</div>

<p><br /></p>

<h2 id="section">많은 함수를 동시에 실행하려면 코루틴을 사용하자</h2>
<p>스레드는 서로 안전하게 동작하기 위해서는 Lock이나 Queue를 사용해야 하며, 메모리와 CPU 사용이 많다. 아주 많은 함수를 스레드로 동작시키는 것은 무리가 있다. 파이썬에서는 이런 문제를 코루틴으로 해결한다. 코루틴은 제너레이터를 소비하는 코드에서 send 함수를 사용하여 역으로 제너레이터 함수의 각 yield 표현식에 값을 보낼 수 있게 하는 방법이다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>def my_coroutine():
    while True:
        received = yield
        print('Received:', received)

it = my_coroutine()
next(it)
it.send('First')
it.send('Second')
</code></pre>
</div>

<p><br /></p>

<h2 id="concurrentfutures--">진정한 병렬성을 실현하려면 concurrent.futures 를 고려하자</h2>
<p>CPU 병목점을 C확장 모듈로 옮겨서 해결할 수 있는데, 비용이 크고 버그가 생길 수 있다. multiprocessing 모듈을 활용하면 자식 프로세스로 추가적인 인터프리터를 실행하려 병렬로 여러 CPU 코어를 활용할 수 있다. GIL 역시 분리된다.  multiprocessing을 위해서는 부모와 자식 프로세스간에 일어나는 직렬화와 역직렬화 과정이 필요하지만 concurrent.futures 의 간단한 모듈과 ProcessPoolExecutor 클래스는 이 작업을 간단하게 처리할 수 있는 기능을 제공한다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>pool = ProcessPoolExecutor(max_workers=2)
results = list(pool.map(my_func, args))
</code></pre>
</div>

<p><br /></p>

<p><a href="http://www.aladin.co.kr/shop/wproduct.aspx?ItemId=80277523">
  <img class="book" style="width: 30%; height: 30%" src="http://image.aladin.co.kr/product/8027/75/cover/k212434638_1.jpg" />
</a></p>

</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/subprocess">subprocess</a>,&nbsp;<a href="/tag/thread">thread</a>,&nbsp;<a href="/tag/파이썬">파이썬</a>,&nbsp;<a href="/tag/concurrent.futures">concurrent.futures</a>,&nbsp;<a href="/tag/코루틴">코루틴</a>
</section>








<section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'underlinee';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



</div>
</div>

    </div>

    <footer class="site-footer" style="background-image: url(/assets/footer_image.jpg)";>

  <div class="wrapper">

    <h3 class="footer-heading">Underlinee</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
        
        
          <li class="nav-link"><a href="/bookshelf/">Bookshelf</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:jb.squee@daum.net">
            <i class="fa fa-envelope-o"></i>
            <span class="username">jb.squee@daum.net</span>
          </a>
        </li>
      </ul>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });
});

</script>




<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-112755509-1', 'auto');
  ga('send', 'pageview', {
    'page': '/devbook/2018/03/05/9791186978825.html',
    'title': '이펙티브 파이썬 - 병행성과 병렬성'
  });
</script>



  </body>

</html>
