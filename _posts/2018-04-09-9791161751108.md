---
layout: post
title:  "스프링 5.0 마이크로서비스 - MSA 개념 적용"
date:   2018-04-09 00:10:01
group: 책읽고밑줄
booklink: "http://www.aladin.co.kr/shop/wproduct.aspx?ItemId=132176859"
bookimg: "http://image.aladin.co.kr/product/13217/68/cover/k462532593_1.jpg"
tags:	스프링5.0마이크로서비스 MSA 
---

마이크로서비스는 한 마디로 좋다. 하지만 그 개념이 올바르게 자리잡지 않는다면 해로울 수도 있다. 마이크로서비스에 대한 잘못된 해석과 잘못된 선택은 돌이킬 수 없는 실패로 이어질 수도 있다. 

<br/>

## 마이크로서비스 경계 설정
- 검토 중인 기능이 **자율적**이라면 마이크로서비스의 경계가 될 수 있다. 
- 자원 소모량, 비즈니스 효용성, 유연성 측면 등에서 어떤 컴포넌트를 떼어내 분리하는 것이 효과적인지 분석하자. 
- **폴리글랏 관점**에서 경계를 설정할 수 있다. 다양한 비기능/기능적 요구 사항을 충족시키려면 컴포넌트마다 다른 아키텍처가 필요할 수 있다. 
- 모든 기능 모듈이 동일한 **확장성**을 필요로 하지는 않는다. 확장에 대한 요구사항을 기준으로 마이크로서비스의 경계를 설정할 수 있다. 
- **단일 책임 원칙**에서 처럼 하나의 마이크로서비스는 여러 가지 책임을 담당해서는 안된다. 하지만 품질등의 이유로 인해 하나의 비즈니스 범위가 여러 개의 서비스에 걸쳐 나눠 처리될 수도 있다. 
- **결합과 응집**은 경계를 설정하는 데 중요한 기준이다. 너무 많은 정보 교환이나 순환 의존 관계가 없어야 하며 트랜잭션 범위가 여러 마이크로서비스에 걸치지 않게 하는 것도 중요하다. 
- DDD는 경계 지어진 컨텍스트를 하나의 제품과 짝짓는 것을 권장한다. 마이크로서비스를 하나의 **제품**이라고 생각해보자.

<br/>

## 통신 방식 설계
요청-응답 형태로 진행되는 **동기 방식 통신**에서는 애플리케이션은 상태가 없고, 공유 메시지 서버 같은 인프라스트럭처상의 의존 관계가 없어 관리에 드는 노력도 상대적으로 적다. 에러도 요청자에게 즉시 반환된다. 대신 마이크로서비스 사이에 고정적인 의존 관계가 추가되어 하나의 서비스에서 문제가 생기면 전체 서비스 체인이 동작하지 못하게 된다. 

발동-망각 형태로 진행되는 **비동기 방식 통신**은 리액티브한 이벤트 루프 방식에 바탕은 둔다. 서비스는 보다 독립적이고 하나의 서비스에 문제가 생기더라도 전체에 영향을 주지는 않는다. 단점은 외부 메시징 서버에 의존하게 된다는 것이다. 메시징 서버가 장애를 견딜 수 있게 처리해야 한다. 

두 방식을 적절히 조합해서 사용할 필요가 있다. 원칙적으로 비동기 방식이 확장성이 뛰어난 마이크로서비스 시스템에 적합하지만 모든 것을 비동기 방식으로 모델링하면 시스템 설계가 매우 복잡해질 수 있다. 

<br/>

## 트랜잭션 경계 설정
트랜잭션의 경계는 로컬 트랜잭션을 이용해서 마이크로서비스를 벗어나지 않게 정의해야 한다. 마이크로서비스 환경에서 분산된 글로벌 트랜잭션은 피해야 한다. 

중간에 일관성이 맞지 않는 순간이 있지만 최종적으로 모두 맞게 되는 **eventual consistency**는 마이크로서비스에서 분산 트랜잭션을 처리하는데 적합하다. 최종적 일관성을 적용하려면 기능과 데이터를 다시 모델링하고 실패를 최소화 하기 위해 작업의 순서를 정해야 하며, 최종적으로 일관성을 맞추는 작업 모두를 포함할 수 있다. 

<br/>

## 공유 라이브러리 처리
마이크로서비스의 바탕에 깔려있는 원칙은 자율성과 자기 완비성이다. 이 원칙을 준수하기 위해 코드와 라이브러리를 복제해야 하는 상황이 있을 수 있다. 의존 관계를 추가하는 것보다 코드를 중복해서 따로 갖는것이 관리나 성능에서 더 나은 점이 있으나 이는 DRY 원칙에 어긋난다. 이는 **의존 관계와 코드 중복 사이에 발생하는 트레이드오프**다. 

공통되는 부분을 별도의 마이크로서비스로 떼어내는 것도 가능하지만, 신중한 분석이 필요하다. 비즈니스범위나 분류 관점에서 마이크로서비스로 분류되지 않는 부분을 공통이라는 이유만으로 떼어낸다면 복잡성 증가라는 비용이 더 클 수도 있기 때문이다. 여러 서비스에 공통라이브러리를 복제하는 것과 통신 관점의 오버헤드도 트레이드오프 관계다. 

<br/>

## 마이크로서비스의 API 게이트웨어
클라이언트 측 프레임워크가 발전함에 따라 서버는 Restful 서비스만 노출하는 방식으로 개발되고 있다. 이는 기대사항의 불일치와 페이지 렌더링을 위한 여러번의 요청이라는 문제를 일으킨다. 

이런 문제를 해결하기 위해 최소한의 정보만을 링크와 함께 전달해서 상세한 정보는 링크를 통해 얻는 방식, 쿼리 문자열로 필요한 필드만 요청하는 방식이 있다. 그리고 클라이언트와 서버 사이에 있는 게이트웨이 컴포넌트가 데이터 소비자 명세에 따라 데이터를 변환하는 방식이 있다. API 게이트웨이는 미들맨으로서 여러 마이크로서비스로부터 API를 조합하고 변환하는 역할을 수행할 수 있다. 

<br/>