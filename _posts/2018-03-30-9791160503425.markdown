---
layout: post
title:  "이펙티브 SQL - 쿼리 플랜 분석하기"
date:   2018-03-28 00:12:59
categories: DevBook
tags:	이펙티브SQL sql queryplan explain  
---

## 사용 중인 시스템의 쿼리 분석기 사용법을 파악하자
DBMS에 따라 특정 기능이나 좋은 성능을 보이는 해결책이 다르다. SQL문은 실행하기 전에 DBMS의 옵티마이저가 최적으로 수행할 수 있는 방법을 결정한다. 실행 계획을 생성해서 이를 결정하는데, 실행 계획에 따라 SQL문은 단계적으로 수행된다. 옵티마이저는 소스 코드를 실행 프로그래으로 변환하는 컴파일러로 볼 수 있는데, SQL 문을 실행 계획으로 변환한다. 특정 SQL 문에 대한 실행 계획을 보면 성능 문제를 식별하는 데 도움이 된다.

실행 계획을 확인하고 해석하는 방법은 DBMS 관련 문서를 참고한다. MYSQL은 SQL 앞에  EXPLAIN 키워드를 붙여 실행 계획을 확인한다. 실행 계획에 나온 정보는 지나면 바뀔 수 있다는 점을 기억하자. 

<br/>

## 쿼리 플랜의 작동 원리를 이해하자
실행 계획을 읽을 때마다 실행 계획을 물리적 동작으로 해석하며, 사용되지 않는 인덱스가 있는지 분석해 그 이유를 파악한다. 데이터베이스 시스템을 도서관, 필요한 데이터를 책이라고 보고 인덱스를 색인 카드라고 생각해보자. 필요한 책이 있을 때 해당 조건에 맞는 색인 카드가 없다면 책을 쉽게 찾을 수 없다. 원하는 조건에 따라 색인 카드를 추가로 만들어야 할 수도 있고, 여러 색인 카드를 조합해서 쉽게 책을 찾을 수 있는데, 색인 카드를 잘 활용하고 있지 못하는 경우도 있을 수 있다. 색인 카드가 제대로 활용되지 못하고 있다면 뭔가가 잘못 되었음을 알고 분석을 시작하면 된다.  다시 데이터 베이스 시스템 용어로 바꾸어 생각하면 다음과 같다, 

- INDEX Seek : 색인 카드를 훑어보기
- INDEX Scan: 색인 카드 덩어리를 뽑아내기 
- Key Lookup : 색인 카드에 포함되지 않은 추가 정보를 얻으려고 책장으로 가기 

실행 계획의 개별 단계를 분석하고 효율적인지를 판단해야 하는데, 효율성은 데이터 분포의 영향을 받는다. 이런 상황을 ‘코끼리와 쥐’ 상황이라고 한다, 결론적으로 ‘나쁜’ 연산이 아니라 쿼리에 적합한 연산이 무엇인지 분석해야 한다. 

좋은 실행 계획을 얻으려면 한 쿼리에 국한되지 않는 인덱스를 추가한다. 데이터베이스의 전반적인 가용성을 고려해 추가한 인덱스가 가능한 한 많은 쿼리에 적용되는지 확인한다.

<br/>


<a href="http://www.aladin.co.kr/shop/wproduct.aspx?ItemId=124421253">
  <img class="book" style="width: 30%; height: 30%" src="http://image.aladin.co.kr/product/12442/12/cover/k802531656_1.jpg"/>
</a>
