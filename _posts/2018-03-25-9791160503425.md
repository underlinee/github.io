---
layout: post
title:  "이펙티브 SQL - 인덱스 설계와 프로그램적 처리"
date:   2018-03-24 00:10:59
group: 책읽고밑줄
booklink: "http://www.aladin.co.kr/shop/wproduct.aspx?ItemId=124421253"
bookimg: "http://image.aladin.co.kr/product/12442/12/cover/k802531656_1.jpg"
tags:   이펙티브SQL DB
---


## 인덱스를 만들 때는 널을 고려하자
데이터베이스 시스템이 인덱스로 생성된 컬럼의 널 값을 어떻게 처리하는지 고려해야 한다. NULL을 검색하고 싶은데 컬럼 값의 대다수가 NULL 이면 이 컬럼은 인덱스로 만들지 않거나 테이블을 재설계하는 편이 낫다. 컬럼에 있는 값을 검색하고 싶은데 NULL 이 대부분이라면 NULL 값을 제외하고 인덱스를 만드는 것이 낫다. 인덱스에서 NULL에 대한 처리는 데이터베이스마다 다르다. 

<br/>

## 인덱스와 데이터 스캔을 최소화하도록 인덱스는 신중히 만들자
데이터를 찾는 프로세스는 인덱스 스캔, 인텍스 탐색, 테이블 스캔이 있다. 조회시 칼럼에 유니크 인덱스가 있는 경우 인덱스 탐색으로 정확히 데이터를 짚어내고, 일반 인덱스라면 인덱스 스캔, 인덱스가 없다면 테이블 스캔을 한다. 인덱스는 테이블에 비해 훨씬 작고 특별히 스캔용으로 설계된 객체이므로, 일반적으로 테이블 스캔보다 인덱스 스캔이 월등히 빠르다. 그러나 인덱스가 만능 해결사는 아니다. 
- 인덱스 컬럼 하나를 갱신할 때마다 인덱스 테이블 하나 이상을 갱신해야 하기 때문에, 종종 테이블 갱신보다 비용이 많이 든다. 갱신 작업이 많은 테이블의 인덱스는 면밀히 검토해야 한다. 
- 쿼리에 사용하는 컬럼이 여러개일때 해당 컬럼을 순서의 맞추어 생성해야 한다. 개별적으로 생성된 인덱스가 효율적인 쿼리 플랜을 보장하지 않는다. 
- 인덱스는 테이블이 클 때만 사용하는 것이 좋다. 데이터베이스는 테이블이 작으면 데이터를 모두 메모리에 올려놓기 때문에 무슨 작업을 하든 빠르게 동작한다. 

<br/>

## 인덱스를 단순 필러링 이상의 목적으로 사용하자
인덱스란 데이터베이스 내에 있는 독특한 데이터 구조체다. 생성된 각 인덱스에는 별도의 저장 공간이 필요하며, 인덱스화된 테이블 데이터의 복사본이 있어 과잉 데이터를 저장한다. 하지만 이런 과잉테이터가 있음에도 테이블의 모든 로우를 검색하지 않고 데이터 위치를 빠르게 찾아서 테이블에 있는 데이터를 가져오는 속도를 향상시키기 때문에 매우 유용하다. 데이터 조회 뿐만 아니라 다른 목적으로도 인덱스는 사용될 수 있다. 
- 조인 조건에 사용된 컬럼의 인덱스도 조인 성능에 영향을 미칠 수 있다. 
- Where 절에서 필요한 컬럼에 모두 인덱스가 있다면 테이블 스캔할 필요가 없어 쿼리가 더 효율적이 된다. 
- 인덱스는 미리 정렬하는 방식으로 데이터를 저장하기 때문에 Order By 절의 효율에도 영향을 준다. 

<br/>

## 데이터의 부분 집합을 포함하거나 제외하려면 필터링된 인덱스를 사용하자
필터링된 인덱스는 적은 비율의 로우에 인덱스를 사용할 때 저장 용량을 절약할 수 있어 유용하다. 필터링된 인덱스는 인덱스를 만들 때 Where 절을 추가해서 생성한다. 테이블 전체의 데이터 중 차지하는 비율이 적고 Where 절에서 빈번히 사용되는 값이 있을 때 필터링된 인덱스를 사용하면 전통적인 인덱스에 비해 그 성능이 월등히 좋아진다. 
```sql
CREATE NONCLUSTERED INDEX PendingDocuments 
ON DocumentStatus (DocumentNumber, Status)
WHERE Status IN (‘publication’, ‘expiration’)
```

<br/>

## 프로그래밍으로 검사하는 대신 선언적 제약 조건을 사용하자
SQL은 데이터 무결성을 강화하는 방법으로 NOT NULL, UNIQUE, PRIMARY KEY, FOREIGN KEY, CHECK, DEFAULT 제약 조건을 사용할 수 있다. 
<br/>
데이터 베이스 무결성을 위해 프로그램 코드로 규칙을 작성할 수도 있다. 하지만, 비즈니스 규칙과 데이터 간 관계를 관리하고 강화하는 것은 데이터 모델의 일부분이어야 하며,그 역할은 데이터 베이스에서 수행해야 한다. 모든 사람이 같은 데이터로 작업하고, 이 데이터를 한 가지 방식으로 갱신되게 하려면 데이터 규칙이 애플리케이션에 독립적이어야 한다. 이렇게 해야 계속해서 코들 관리하는 부담을 덜 수 있다. 물론 그렇더라고 무결성이 훼손될 수 있지만, 최소한 가능성은 줄어든다. 

<br/>